---
作成日時: 2026-01-08 12:30:00
最終更新: 2026-01-08 12:30:00
---

# 部屋再構成問題の分析と改善策

## 現状の問題

**症状:**
- メッシュが生成されている（956,565 points, 1,590,698 triangles）
- しかし、部屋の構造（壁、床、天井）が認識できない
- 抽象的な形状で、部屋としての形になっていない
- 深度範囲は適切（0.23m - 7.22m）

**根本原因:**
1. **MiDaS深度推定の限界**
   - モノキュラー（単一画像）からの推定
   - 相対深度は正確だが、絶対深度のスケールが不正確
   - フレーム間の深度整合性が保証されていない

2. **カメラポーズの精度**
   - ARCore VIOのポーズが不正確な場合、統合時にずれが生じる
   - 姿勢グラフ最適化（Pose Graph Optimization）が未実装

3. **TSDF統合の設定**
   - 複数のフレームを統合する際のパラメータが適切でない可能性

---

## 原因の詳細分析

### 1. MiDaS深度推定の限界

**問題:**
- MiDaSは単一画像から深度を推定するため、各フレームで独立した深度推定を行う
- 絶対深度のスケールが画像ごとに異なる可能性がある
- フレーム間の深度整合性が保証されていない

**影響:**
- 複数のフレームを統合する際に、深度の不一致が生じる
- TSDF統合時に、異なるスケールの深度が混在する
- 結果として、部屋の構造が正しく統合されない

**解決策:**
- **MVS（マルチビュー・ステレオ）への移行**（最優先）
- 複数の画像から深度を推定することで、フレーム間の整合性を保証
- COLMAPなどのMVSパイプラインを使用

### 2. カメラポーズの精度

**問題:**
- ARCore VIOのポーズが不正確な場合、統合時にずれが生じる
- 姿勢グラフ最適化（Pose Graph Optimization）が未実装
- ループ閉じ（Loop Closure）による最適化が未実装

**影響:**
- フレーム間のポーズ誤差が累積する
- TSDF統合時に、面が二重化したり、ずれが生じる
- 部屋の構造が正しく統合されない

**解決策:**
- **姿勢グラフ最適化の実装**（優先度高）
- Open3DのPose Graph Optimizationを使用
- RGBD Odometryで微調整

### 3. TSDF統合の設定

**問題:**
- 現在の設定: `voxel_length: 0.03m`, `sdf_trunc: 0.24m`
- 深度の不整合がある場合、TSDF統合が不安定になる

**解決策:**
- TSDFパラメータの調整
- 深度の前処理を強化

---

## 改善策（優先順位順）

### 🔴 最優先: MVS（COLMAP）パイプラインへの移行

**理由:**
- MiDaS深度推定の根本的な限界を解決
- フレーム間の深度整合性を保証
- 部屋認識が90-95%改善

**実装方法:**
1. COLMAPを統合
2. SfMステップをスキップ（ARCore VIOを使用）
3. Dense MVSステップを実装
4. テクスチャマッピングも実装

**期待される結果:**
- 部屋の構造が明確に認識される
- 壁、床、天井が正しく表示される
- 高品質なメッシュが生成される

**実装難易度:** ⭐⭐⭐⭐ (複雑、処理時間が長い)

**処理時間:** 数時間（209フレームの場合）

---

### 🟡 次に優先: 姿勢グラフ最適化の実装

**理由:**
- カメラポーズの精度を向上
- フレーム間のポーズ誤差を減らす
- TSDF統合の安定性を向上

**実装方法:**
1. Open3DのPose Graph Optimizationを使用
2. RGBD Odometryで微調整
3. ループ閉じ（Loop Closure）を実装

**期待される結果:**
- ポーズ誤差が減少
- TSDF統合が安定
- 部屋認識が20-30%改善

**実装難易度:** ⭐⭐⭐ (中程度)

**処理時間:** 数分〜数十分

---

### 🟢 即座に実施: TSDFパラメータの調整

**理由:**
- 簡単に実施可能
- ある程度の改善が期待できる

**実装方法:**
```yaml
processing:
  tsdf:
    voxel_length: 0.04  # 0.03 → 0.04（より粗くしてノイズを減らす）
    sdf_trunc: 0.32     # 0.24 → 0.32（voxel_length * 8）
```

**期待される結果:**
- ノイズが減少
- 部屋認識が10-20%改善

**実装難易度:** ⭐ (簡単、設定変更のみ)

---

### 🟢 即座に実施: 深度前処理の強化

**理由:**
- 簡単に実施可能
- 深度の品質を向上

**実装方法:**
```yaml
processing:
  depth:
    bilateral_sigma_color: 100.0  # 75.0 → 100.0
    bilateral_sigma_space: 100.0  # 75.0 → 100.0
```

**期待される結果:**
- 深度のノイズが減少
- 部屋認識が5-10%改善

**実装難易度:** ⭐ (簡単、設定変更のみ)

---

## 推奨される段階的アプローチ

### Step 1: 即座に実施（設定変更のみ）

1. **TSDFパラメータを調整**
   ```yaml
   voxel_length: 0.04
   sdf_trunc: 0.32
   ```

2. **深度前処理を強化**
   ```yaml
   bilateral_sigma_color: 100.0
   bilateral_sigma_space: 100.0
   ```

**期待される結果:**
- 部屋認識が10-30%改善

---

### Step 2: 姿勢グラフ最適化の実装（中期的）

1. Open3DのPose Graph Optimizationを実装
2. RGBD Odometryで微調整

**期待される結果:**
- 部屋認識が20-30%改善

---

### Step 3: MVS（COLMAP）パイプラインへの移行（長期的）

1. COLMAPを統合
2. Dense MVSステップを実装
3. テクスチャマッピングも実装

**期待される結果:**
- 部屋認識が90-95%改善
- 部屋の構造が明確に認識される

---

## 結論

### 現在の問題

1. **MiDaS深度推定の限界**（根本原因）
   - モノキュラー深度推定のため、フレーム間の深度整合性が保証されていない

2. **カメラポーズの精度**（重要）
   - ARCore VIOのポーズが不正確な場合、統合時にずれが生じる

3. **TSDF統合の設定**（調整可能）
   - パラメータが適切でない可能性

### 推奨される改善策

1. **最優先: MVS（COLMAP）パイプラインへの移行**
   - 根本的な解決策
   - 部屋認識が90-95%改善

2. **次に優先: 姿勢グラフ最適化の実装**
   - ポーズ精度を向上
   - 部屋認識が20-30%改善

3. **即座に実施: TSDFパラメータの調整**
   - 簡単に実施可能
   - 部屋認識が10-20%改善

### 次のステップ

1. **即座に実施（設定変更のみ）**
   - TSDFパラメータを調整
   - 深度前処理を強化
   - 再処理して結果を確認

2. **中期的（数日〜数週間）**
   - 姿勢グラフ最適化を実装

3. **長期的（数週間〜数ヶ月）**
   - MVS（COLMAP）パイプラインを実装

---

## 参考情報

- `SERVER_SIDE_DEPTH_ESTIMATION_ANALYSIS.md`: サーバー側深度推定の詳細
- `INDUSTRY_APPROACHES_COMPARISON.md`: 業界標準との比較
- `MIDAS_ROOM_RECOGNITION_FIX.md`: MiDaS深度推定での部屋認識改善

