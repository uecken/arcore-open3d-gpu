# ARCore-COLMAP 座標系位置合わせ方式の調査

**作成日時:** 2026-01-09 13:00:02  
**更新日時:** 2026-01-09 13:10:00  
**作成者:** AI Assistant  
**対象Job:** 6d24a96e（約37秒、224フレーム）

---

## Viewer参照

以下のURLで各方式の結果を確認可能:

| 方式 | Viewer URL |
|------|------------|
| オリジナル | http://localhost:8002/viewer/6d24a96e |
| 方式3（5秒） | http://localhost:8002/viewer/6d24a96e_5sec |
| 方式3（2秒） | http://localhost:8002/viewer/6d24a96e_2sec |

---

## 1. 問題の概要

COLMAPのSfM（Structure from Motion）で算出した軌跡と、ARCoreで記録した軌跡にずれがある。

### 位置誤差の測定結果

| 指標 | 値 |
|------|-----|
| 初期誤差（平均） | 0.62m |
| 初期誤差（中央値） | 0.48m |
| 最大誤差 | 2.45m |
| 前半（0-19秒）誤差 | 0.51m |
| 後半（20-37秒）誤差 | 0.73m |

### ⚠️ 回転誤差の測定結果（重要）

| 指標 | 値 |
|------|-----|
| 向き誤差（平均） | **54.95°** |
| 向き誤差（中央値） | 52.49° |
| 最大誤差 | 178.75° |
| 最小誤差 | 4.64° |

### 原因

1. **時間経過によるドリフト** - COLMAPのSfMは累積誤差が発生
2. **スケールの違い** - COLMAP: 任意スケール、ARCore: メートル
3. **座標軸の違い** - Y軸の向きが異なる
4. **⚠️ 回転のずれ** - 座標変換後も平均55°のずれが残る

---

## 1.5 RFIDタグ位置への影響（重要）

RFIDタグの位置は、カメラの**位置**と**向き**の両方に依存する。

### 回転誤差の影響

```
タグまでの距離 × tan(回転誤差) = 位置誤差
```

| タグ距離 | 回転誤差55°での位置誤差 |
|---------|----------------------|
| 1m | **1.43m** |
| 2m | **2.85m** |
| 3m | **4.28m** |

### 位置誤差 vs 回転誤差の影響比較

| 誤差タイプ | 値 | 2m先のタグへの影響 |
|-----------|-----|-------------------|
| 位置誤差（方式3補正後） | 0.14m | 0.14m |
| **回転誤差** | **55°** | **2.85m** |
| **合計** | - | **≈3m** |

**⚠️ 結論: 回転誤差の影響が位置誤差の20倍以上！**

---

## 2. 位置合わせ方式の比較

### 方式1: 全体剛体変換

**概要:** 全点に同一の回転+並進を適用

```
T(x) = s * R * x + t
- s: スケール
- R: 回転行列（3x3）
- t: 並進ベクトル（3x1）
```

| 利点 | 欠点 |
|------|------|
| ✓ メッシュ形状が完全保持 | ✗ ドリフトを補正できない |
| ✓ 処理が高速 | ✗ 局所的なずれが残る |
| ✓ 実装が簡単 | ✗ 誤差0.3-0.6mが限界 |

**結果:** 平均誤差 0.62m → 改善なし

---

### 方式2: COLMAP再実行（ARCoreポーズ初期値）

**概要:** ARCoreのポーズを初期値としてCOLMAPに渡し、最初からARCore座標系でメッシュ生成

```
ARCore画像 + ARCoreポーズ
        ↓
    COLMAP SfM（ARCoreポーズを拘束条件）
        ↓
    COLMAP MVS（ARCore座標系）
        ↓
    メッシュ（補正不要）
```

| 利点 | 欠点 |
|------|------|
| ✓ メッシュが歪まない | ✗ 処理時間が長い（数十分〜） |
| ✓ 理論的に最も正確 | ✗ 実装が複雑 |
| ✓ 座標系が最初から統一 | ✗ COLMAPの仕様理解が必要 |

**結果:** 未実装

---

### 方式3: セグメント別局所並進補正（現在採用）

**概要:** 時間セグメントごとにCOLMAP軌跡をARCore軌跡に合わせる

```
時間軸: |---2秒---|---2秒---|---2秒---|...
         [Seg 0]   [Seg 1]   [Seg 2]

各セグメントで:
  offset = mean(ARCore位置) - mean(COLMAP位置)
  COLMAP補正位置 = COLMAP位置 + offset
```

| 利点 | 欠点 |
|------|------|
| ✓ 軌跡精度が大幅改善 | ✗ メッシュに若干の歪み |
| ✓ 処理が高速（数秒） | ✗ セグメント境界で不連続 |
| ✓ 実装が簡単 | |

**セグメントサイズ別の結果:**

| セグメント | 平均誤差 | 改善率 | 点/セグ | 不連続性 |
|-----------|---------|--------|---------|----------|
| 10秒 | 0.51m | 17.5% | 56 | 1.10m |
| 5秒 | 0.31m | 49.4% | 28 | 1.50m |
| **2秒** | **0.14m** | **77.3%** | **12** | 1.53m |
| 1秒 | 0.09m | 86.0% | 6 | 1.32m |
| 0.5秒 | 0.07m | 88.6% | 3 | 1.32m |
| 0.2秒 | 0.28m | 54.9% | 2 | 悪化 |

**採用:** 2秒セグメント（誤差0.14m、改善77%）

---

## 3. 方式選択の指針

| 優先事項 | 推奨方式 |
|---------|---------|
| RFIDタグ位置精度 | **方式3**（セグメント補正） |
| メッシュ品質 | **方式1**（剛体変換）または **方式2** |
| 処理速度 | **方式3** |
| 理論的最適 | **方式2**（COLMAP再実行） |

---

## 4. 現在の実装状態

### config.yaml設定

```yaml
alignment:
  segment_correction:
    enable: true
    segment_duration_sec: 2.0  # 2秒セグメント
    min_points_per_segment: 3
  mesh_correction:
    enable: true
    interpolation_neighbors: 3
```

### 生成ファイル

- `trajectory_colmap_corrected.json` - 補正済みCOLMAP軌跡
- `mesh_aligned.ply` - 補正済みメッシュ
- `point_cloud_aligned.ply` - 補正済み点群

### Viewerで選択可能なジョブ

| Job ID | 方式 | 誤差 |
|--------|------|------|
| 6d24a96e | オリジナル | 0.62m |
| 6d24a96e_5sec | 方式3（5秒） | 0.31m |
| 6d24a96e_2sec | 方式3（2秒） | 0.14m |

---

## 5. 今後の検討事項

### 方式2の実装に必要なこと

1. ARCoreポーズをCOLMAP形式に変換
2. COLMAPデータベースへの書き込み
3. Bundle Adjustmentの拘束条件設定
4. MVSパイプラインとの連携

### 方式3の改善案

1. セグメント境界のスムージング
2. 回転補正の追加
3. 外れ値の自動検出・除外

---

## 6. 結論（2026-01-09 13:10 更新）

### ⚠️ 重要な発見

**回転誤差が支配的！**
- 位置誤差: 0.14m（方式3で77%改善）
- 回転誤差: **55°（未補正）**
- 2m先のタグ: 位置誤差0.14m + 回転による誤差2.85m = **約3m**

### 方式の再評価

| 方式 | 位置補正 | 回転補正 | RFIDへの影響（2m先） |
|------|---------|---------|---------------------|
| 方式1 | △ 0.62m | ✗ なし | 約3.5m |
| 方式2 | ○ | **○ 可能** | **改善の可能性** |
| 方式3 | ◎ 0.14m | ✗ なし | 約3m |

### 推奨

**RFIDタグの向きが重要な場合:**
→ **方式2の実装を推奨**（ARCoreの回転情報をCOLMAPに渡す）

**メッシュ表示のみの場合:**
→ 方式3（2秒セグメント）で十分

### 方式2の実装優先度が上がった理由

1. COLMAPの`pose_priors`テーブルには位置だけでなく回転も渡せる可能性
2. ARCoreは高精度な回転情報を持っている
3. 回転誤差55°はRFID位置精度に致命的

### 次のアクション

1. [ ] 方式2で回転情報も含めてpriorを設定できるか調査
2. [ ] 方式3に回転補正を追加する案も検討
3. [ ] RFIDタグの検出方式（位置のみ vs 位置+向き）を確認

