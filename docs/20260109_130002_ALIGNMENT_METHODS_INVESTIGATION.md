# ARCore-COLMAP 座標系位置合わせ方式の調査

**作成日時:** 2026-01-09 13:00:02  
**作成者:** AI Assistant  
**対象Job:** 6d24a96e（約37秒、224フレーム）

---

## 1. 問題の概要

COLMAPのSfM（Structure from Motion）で算出した軌跡と、ARCoreで記録した軌跡にずれがある。

### 測定結果

| 指標 | 値 |
|------|-----|
| 初期誤差（平均） | 0.62m |
| 初期誤差（中央値） | 0.48m |
| 最大誤差 | 2.45m |
| 前半（0-19秒）誤差 | 0.51m |
| 後半（20-37秒）誤差 | 0.73m |

### 原因

1. **時間経過によるドリフト** - COLMAPのSfMは累積誤差が発生
2. **スケールの違い** - COLMAP: 任意スケール、ARCore: メートル
3. **座標軸の違い** - Y軸の向きが異なる

---

## 2. 位置合わせ方式の比較

### 方式1: 全体剛体変換

**概要:** 全点に同一の回転+並進を適用

```
T(x) = s * R * x + t
- s: スケール
- R: 回転行列（3x3）
- t: 並進ベクトル（3x1）
```

| 利点 | 欠点 |
|------|------|
| ✓ メッシュ形状が完全保持 | ✗ ドリフトを補正できない |
| ✓ 処理が高速 | ✗ 局所的なずれが残る |
| ✓ 実装が簡単 | ✗ 誤差0.3-0.6mが限界 |

**結果:** 平均誤差 0.62m → 改善なし

---

### 方式2: COLMAP再実行（ARCoreポーズ初期値）

**概要:** ARCoreのポーズを初期値としてCOLMAPに渡し、最初からARCore座標系でメッシュ生成

```
ARCore画像 + ARCoreポーズ
        ↓
    COLMAP SfM（ARCoreポーズを拘束条件）
        ↓
    COLMAP MVS（ARCore座標系）
        ↓
    メッシュ（補正不要）
```

| 利点 | 欠点 |
|------|------|
| ✓ メッシュが歪まない | ✗ 処理時間が長い（数十分〜） |
| ✓ 理論的に最も正確 | ✗ 実装が複雑 |
| ✓ 座標系が最初から統一 | ✗ COLMAPの仕様理解が必要 |

**結果:** 未実装

---

### 方式3: セグメント別局所並進補正（現在採用）

**概要:** 時間セグメントごとにCOLMAP軌跡をARCore軌跡に合わせる

```
時間軸: |---2秒---|---2秒---|---2秒---|...
         [Seg 0]   [Seg 1]   [Seg 2]

各セグメントで:
  offset = mean(ARCore位置) - mean(COLMAP位置)
  COLMAP補正位置 = COLMAP位置 + offset
```

| 利点 | 欠点 |
|------|------|
| ✓ 軌跡精度が大幅改善 | ✗ メッシュに若干の歪み |
| ✓ 処理が高速（数秒） | ✗ セグメント境界で不連続 |
| ✓ 実装が簡単 | |

**セグメントサイズ別の結果:**

| セグメント | 平均誤差 | 改善率 | 点/セグ | 不連続性 |
|-----------|---------|--------|---------|----------|
| 10秒 | 0.51m | 17.5% | 56 | 1.10m |
| 5秒 | 0.31m | 49.4% | 28 | 1.50m |
| **2秒** | **0.14m** | **77.3%** | **12** | 1.53m |
| 1秒 | 0.09m | 86.0% | 6 | 1.32m |
| 0.5秒 | 0.07m | 88.6% | 3 | 1.32m |
| 0.2秒 | 0.28m | 54.9% | 2 | 悪化 |

**採用:** 2秒セグメント（誤差0.14m、改善77%）

---

## 3. 方式選択の指針

| 優先事項 | 推奨方式 |
|---------|---------|
| RFIDタグ位置精度 | **方式3**（セグメント補正） |
| メッシュ品質 | **方式1**（剛体変換）または **方式2** |
| 処理速度 | **方式3** |
| 理論的最適 | **方式2**（COLMAP再実行） |

---

## 4. 現在の実装状態

### config.yaml設定

```yaml
alignment:
  segment_correction:
    enable: true
    segment_duration_sec: 2.0  # 2秒セグメント
    min_points_per_segment: 3
  mesh_correction:
    enable: true
    interpolation_neighbors: 3
```

### 生成ファイル

- `trajectory_colmap_corrected.json` - 補正済みCOLMAP軌跡
- `mesh_aligned.ply` - 補正済みメッシュ
- `point_cloud_aligned.ply` - 補正済み点群

### Viewerで選択可能なジョブ

| Job ID | 方式 | 誤差 |
|--------|------|------|
| 6d24a96e | オリジナル | 0.62m |
| 6d24a96e_5sec | 方式3（5秒） | 0.31m |
| 6d24a96e_2sec | 方式3（2秒） | 0.14m |

---

## 5. 今後の検討事項

### 方式2の実装に必要なこと

1. ARCoreポーズをCOLMAP形式に変換
2. COLMAPデータベースへの書き込み
3. Bundle Adjustmentの拘束条件設定
4. MVSパイプラインとの連携

### 方式3の改善案

1. セグメント境界のスムージング
2. 回転補正の追加
3. 外れ値の自動検出・除外

---

## 6. 結論

**現時点での推奨:** 方式3（2秒セグメント補正）

- 軌跡精度: 0.14m（十分な精度）
- 処理速度: 数秒
- メッシュ: 若干の歪みあり（許容範囲）

方式2は理論的に優れているが、実装コストが高い。
RFIDタグの位置精度が0.14mで問題なければ、方式3で十分。

