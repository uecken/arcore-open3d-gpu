# 1611626e 高品質メッシュの生成方法分析

**作成日時:** 2026-01-09 20:15:00  
**対象ジョブ:** 1611626e  
**ステータス:** 調査完了

---

## 概要

ジョブ `1611626e` は非常に高品質なメッシュを生成しており、その生成方法を調査した。

---

## 処理モード

| 項目 | 値 |
|------|-----|
| **処理モード** | RGBD（RGB-D統合） |
| **深度ソース** | ARCore Depth API |
| **GPU加速** | 有効 |

---

## 使用パラメータ

### TSDF (Truncated Signed Distance Function) 設定

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| voxel_length | 0.01m (10mm) | ボクセルサイズ（高密度） |
| sdf_trunc | 0.08m (80mm) | SDF切り捨て距離 |

### 深度設定

| パラメータ | 値 |
|-----------|-----|
| depth_scale | 1000.0 |
| depth_max | 3.0m |
| min_depth | 0.1m |

---

## 入力データ

### セッション情報

| 項目 | 値 |
|------|-----|
| デバイス | Pixel 7 Pro (Android 15) |
| 画像枚数 | 209枚 |
| 深度フレーム数 | 207枚 |
| 撮影間隔 | 0.1m / 5° |
| 画像品質 | 95% |

### 深度データ形式

| 項目 | 値 |
|------|-----|
| ファイル形式 | RAW + PNG |
| RAWファイルサイズ | 28,808 bytes |
| フォーマット | 16-bit深度 |

---

## 生成結果

### オリジナルメッシュ（mesh_original.ply）

| 項目 | 値 |
|------|-----|
| ファイルサイズ | 963.5 MB |
| 頂点数 | 14,742,019 |
| 三角形数 | 19,882,461 |
| 法線 | あり |
| 色 | あり |

### Viewer用メッシュ（mesh.ply）

| 項目 | 値 |
|------|-----|
| ファイルサイズ | 26.4 MB |
| 頂点数 | 259,101 |
| 三角形数 | 500,000 |
| 処理 | 間引き（decimation） |

### メッシュサイズ

| 軸 | サイズ |
|----|--------|
| X | 10.69 m |
| Y | 8.48 m |
| Z | 11.08 m |

---

## 処理パイプライン

```
┌─────────────────────────────────────────────────────────────────┐
│                    RGBD処理パイプライン                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌──────────────┐     ┌──────────────┐     ┌──────────────┐   │
│   │ RGB画像      │     │ ARCore Depth │     │ ARCore Pose  │   │
│   │ (209枚)      │     │ (207枚)      │     │ (VIO)        │   │
│   └──────┬───────┘     └──────┬───────┘     └──────┬───────┘   │
│          │                    │                    │           │
│          └────────────────────┼────────────────────┘           │
│                               │                                │
│                               ▼                                │
│                  ┌────────────────────────┐                    │
│                  │   TSDF Volume統合       │                    │
│                  │   (GPU: Open3D Tensor)  │                    │
│                  │                        │                    │
│                  │   voxel: 10mm          │                    │
│                  │   sdf_trunc: 80mm      │                    │
│                  └────────────┬───────────┘                    │
│                               │                                │
│                               ▼                                │
│                  ┌────────────────────────┐                    │
│                  │   メッシュ抽出          │                    │
│                  │   (Marching Cubes)      │                    │
│                  └────────────┬───────────┘                    │
│                               │                                │
│                               ▼                                │
│                  ┌────────────────────────┐                    │
│                  │   mesh_original.ply    │                    │
│                  │   (14.7M頂点)          │                    │
│                  └────────────┬───────────┘                    │
│                               │                                │
│                               ▼                                │
│                  ┌────────────────────────┐                    │
│                  │   間引き処理            │                    │
│                  │   (Decimation)         │                    │
│                  └────────────┬───────────┘                    │
│                               │                                │
│                               ▼                                │
│                  ┌────────────────────────┐                    │
│                  │   mesh.ply             │                    │
│                  │   (259K頂点)           │                    │
│                  └────────────────────────┘                    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 他のジョブとの比較

| ジョブ | モード | 頂点数 | 三角形数 | 深度ソース |
|--------|--------|--------|----------|------------|
| **1611626e** | **RGBD** | **14,742,019** | **19,882,461** | **ARCore_Depth** |
| 1611626e_mvs | MVS | 14,742,019 | 19,882,461 | ARCore_Depth |
| 9b77e9e6 | MVS_Method2 | 203,326 | 404,397 | ARCore_Depth |

---

## 高品質の理由

### 1. ARCore Depth APIの利用

- **リアルタイム深度推定**: デバイス上で高精度な深度マップを生成
- **VIO連携**: 高精度な位置・姿勢情報と組み合わせ
- **一貫した座標系**: ARCore座標系で統一

### 2. TSDF Volume統合

- **voxel_length: 10mm**: 高密度なボクセルグリッド
- **GPU加速**: Open3D Tensor APIによる高速処理
- **複数フレーム統合**: 207フレームの深度を統合してノイズ低減

### 3. Pixel 7 Pro のセンサー品質

- **高品質カメラ**: 高解像度RGB画像
- **ToFセンサー**: 精度の高い深度推定

---

## 再現方法

### config.yaml 設定

```yaml
processing:
  default_mode: "rgbd"

tsdf:
  voxel_length: 0.01  # 10mm
  sdf_trunc: 0.08     # 80mm

depth:
  scale: 1000.0
  trunc: 3.0
  min_depth: 0.1
```

### 必要条件

1. ARCore Depth APIをサポートするデバイス（Pixel 7 Pro等）
2. 深度データ（RAW形式）を含むセッションデータ
3. GPU（CUDA対応）

---

## 結論

`1611626e` の高品質メッシュは、以下の組み合わせによって実現された：

1. **RGBD処理モード**: COLMAPではなく、ARCore Depth + TSDFを使用
2. **ARCore Depth API**: デバイス上での高精度深度推定
3. **高密度TSDF**: 10mmボクセルによる詳細なメッシュ生成
4. **GPU加速**: 高速かつ大規模なTSDF統合が可能

**MVSモード（COLMAP）との違い:**
- MVSは画像のみから深度を推定（計算コスト高、精度は画像品質に依存）
- RGBDはARCore深度を直接使用（高精度、高速）

---

## 関連ファイル

- `pipeline/rgbd_integration_gpu.py` - RGBD統合パイプライン
- `config.yaml` - TSDF設定
- `data/results/1611626e/` - 生成結果

---

## 追加検証: 再生成テスト

### 検証日時: 2026-01-09 20:50:00

同一セッションデータを使用して新規ジョブ `1611626e_rgbd_20260109_205031` を作成し、RGBDパイプラインで再処理を実施。

### 使用パラメータ

| パラメータ | 値 |
|-----------|-----|
| voxel_length | 0.01m (10mm) |
| sdf_trunc | 0.08m (80mm) |
| depth_trunc | 5.0m |
| min_depth | 0.2m |
| depth_scale | 1000.0 |

### 結果比較

| 項目 | オリジナル (1611626e) | 再生成 (rgbd_v2) |
|------|----------------------|------------------|
| 点群数 | 9,376,484 | 7,605,737 |
| メッシュ頂点 | 14,742,019 | 9,603,191 |
| メッシュ三角形 | 19,882,461 | 15,831,196 |
| オリジナルサイズ | 963.5 MB | 663.3 MB |
| Viewer用サイズ | 26.4 MB | 44.5 MB |

### 考察と原因分析

**❌ 再生成が低品質な理由:**

再生成スクリプトでは、基本的なTSDF統合のみを行い、以下の後処理を**省略**していた：

| 後処理 | オリジナル | 再生成 |
|--------|----------|--------|
| Poisson再構成 | ✅ 有効 | ❌ 未使用 |
| Laplacian平滑化 | ✅ 10回 | ❌ 未使用 |
| Loop Subdivision | ✅ 2回 | ❌ 未使用 |
| 密度フィルタリング | ✅ 5% | ❌ 未使用 |
| メッシュ最適化 | ✅ 有効 | ❌ 未使用 |

**オリジナルで使用された後処理（config.yaml より）:**

```yaml
mesh:
  method: "poisson"
  
  poisson:
    depth: 10
    density_threshold_percentile: 5
  
  smoothing:
    enable: true
    method: "laplacian"
    iterations: 10
    lambda_filter: 0.3
  
  quality_improvement:
    enable: true
    subdivision:
      enable: true
      method: "loop"
      iterations: 2
```

**結論:**
- オリジナルは `main.py` 経由で処理され、`create_mesh_from_rgbd_volume_gpu()` → `MeshGeneratorGPU` のパイプラインを使用
- 再生成は独自スクリプトで `rgbd.extract_mesh()` を直接使用し、後処理をスキップした
- 高品質メッシュには **Poisson再構成 + 平滑化 + Subdivision** が必須

### Viewer確認

```
オリジナル: http://localhost:8002/viewer/1611626e
再生成: http://localhost:8002/viewer/1611626e_rgbd_20260109_205031
```

---

## 正しい再生成方法

高品質メッシュを再生成するには、**API経由で処理する**必要がある：

### 方法1: WebUI経由

1. セッションデータをアップロード
2. `mode=rgbd` を選択
3. 自動的に後処理が適用される

### 方法2: コード経由（正しい方法）

```python
from pipeline.rgbd_integration_gpu import RGBDIntegrationGPU
from pipeline.mesh_generation_gpu import MeshGeneratorGPU, create_mesh_from_rgbd_volume_gpu

# TSDF統合
rgbd = RGBDIntegrationGPU(config=config, gpu_config=gpu_config)
rgbd.process_session(parser)

# 点群・メッシュ抽出（後処理付き）
pcd, mesh = create_mesh_from_rgbd_volume_gpu(rgbd.volume, config, gpu_config)

# さらにPoissonメッシュ生成（オプション）
generator = MeshGeneratorGPU(config, gpu_config)
mesh = generator.generate(pcd, method='poisson')
```

### 方法3: 独自スクリプト（非推奨）

```python
# ❌ これは低品質な結果になる
mesh = rgbd.extract_mesh()  # 後処理なし
```

---

## 処理パイプライン詳細

```
┌─────────────────────────────────────────────────────────────────┐
│              高品質メッシュ生成パイプライン                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   RGB-D 統合 (TSDF)                                             │
│         │                                                       │
│         ▼                                                       │
│   ┌─────────────────┐                                           │
│   │ extract_mesh()  │ ← 基本的なメッシュ抽出                     │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │ clean_mesh()    │ ← 重複・不正三角形除去                     │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │ Poisson再構成   │ ← 点群→滑らかなメッシュ (depth=10)        │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │ 密度フィルタ    │ ← 低密度領域を除去 (5%)                    │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │ Laplacian平滑化 │ ← エッジを滑らかに (10回)                 │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │ Loop Subdivision│ ← 三角形を細分化 (2回)                    │
│   └────────┬────────┘                                           │
│            │                                                    │
│            ▼                                                    │
│   ┌─────────────────┐                                           │
│   │ Decimation      │ ← Viewer用に間引き (500K triangles)       │
│   └─────────────────┘                                           │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

最終更新: 2026-01-09 21:20:00
