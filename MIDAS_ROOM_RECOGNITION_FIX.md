---
作成日時: 2026-01-08 12:00:00
最終更新: 2026-01-08 12:00:00
---

# MiDaS深度推定で部屋認識を改善

## 問題

MiDaS深度推定は正常に動作していますが、生成された3Dモデルが部屋として認識できません。

**症状:**
- 点群とメッシュは生成されている（215,134 points, 390,134 triangles）
- しかし、部屋の構造（壁、床、天井）が認識できない
- 抽象的な形状で、部屋としての形になっていない

**原因:**
1. **深度範囲が狭すぎる** (min=0.16m, max=2.43m)
   - 部屋の壁までの距離（3-5m）がカバーされていない
   - MiDaS深度推定のスケールが小さすぎる（midas_scale=5.0）

2. **フレーム数が少ない** (43フレーム)
   - 部屋全体をカバーするには、より多くの視点が必要

3. **TSDF解像度が細かすぎる** (voxel_length=0.02m)
   - ノイズを拾いやすく、部屋の構造が統合されにくい

---

## 実施した改善

### 1. MiDaS深度推定のスケールを拡大

**変更前:**
```python
midas_scale = 5.0  # min=0.16m, max=2.43m
```

**変更後:**
```python
midas_scale = 10.0  # より大きな範囲をカバー（0.5m - 8m程度）
```

**効果:**
- 深度範囲が2倍に拡大
- 部屋の壁までの距離（3-5m）をカバー

### 2. 深度の最大値を拡大

**変更前:**
```yaml
depth:
  trunc: 7.0m  # 部屋全体をカバーするには不十分
```

**変更後:**
```yaml
depth:
  trunc: 10.0m  # 部屋全体をカバーするため拡大
```

### 3. 最小深度を調整

**変更前:**
```yaml
depth:
  min_depth: 0.1m  # 近すぎる深度がノイズとして含まれる
```

**変更後:**
```yaml
depth:
  min_depth: 0.2m  # 近すぎる深度を除外してノイズを減らす
```

### 4. TSDF解像度を調整

**変更前:**
```yaml
tsdf:
  voxel_length: 0.02m  # 細かすぎてノイズを拾いやすい
  sdf_trunc: 0.16m
```

**変更後:**
```yaml
tsdf:
  voxel_length: 0.03m  # 部屋全体を安定して統合するため
  sdf_trunc: 0.24m
```

**効果:**
- ノイズを減らしつつ、部屋の構造を保持
- より安定した統合が可能

### 5. デバッグ出力を追加

**追加した機能:**
- 10フレームごとに深度統計情報を表示
- 部屋全体の深度範囲を確認可能

---

## 期待される改善

### 深度範囲の拡大

**変更前:**
- min=0.16m, max=2.43m
- 部屋の壁までの距離（3-5m）がカバーされていない

**変更後（期待値）:**
- min=0.2m - 0.5m, max=5m - 8m
- 部屋の壁までの距離をカバー

### 部屋認識の改善

**期待される結果:**
- 壁、床、天井が明確に認識される
- 部屋の構造が3Dモデルに反映される
- 部屋として認識できる形状になる

---

## 次のステップ

### 1. 新しいジョブでテスト

**推奨:**
- 同じ部屋を再スキャン
- より多くのフレームを撮影（100-200フレーム推奨）
- 部屋全体を360度カバーするように移動

**撮影のコツ:**
- ゆっくりと移動しながら撮影
- 壁、床、天井を明確に撮影
- オーバーラップを確保（前のフレームと60-80%重複）

### 2. 深度範囲の確認

**次回のジョブ実行時に:**
```
First frame depth stats: min=X.XXm, max=X.XXm, mean=X.XXm
```

**確認項目:**
- **min値**: 0.2m - 0.5m程度が理想
- **max値**: 5m - 8m程度が理想
- **mean値**: 2m - 4m程度が理想

### 3. パラメータの微調整（必要に応じて）

**深度範囲が適切でない場合:**

**max値が小さすぎる場合**（例: max=3m）:
```python
midas_scale = 15.0  # 10.0 → 15.0に増やす
```

**max値が大きすぎる場合**（例: max=15m）:
```python
midas_scale = 7.0  # 10.0 → 7.0に減らす
```

**min値が小さすぎる場合**（例: min=0.05m）:
```yaml
depth:
  min_depth: 0.3m  # 0.2m → 0.3mに増やす
```

---

## 追加の改善案

### 1. フレーム間引きを無効化（より多くのフレームを使用）

**現在:** 全フレームを使用（43フレーム）

**推奨:** より多くのフレームを撮影（100-200フレーム）

**理由:**
- より多くの視点から部屋を撮影することで、精度が向上
- 部屋全体をカバーしやすくなる

### 2. カメラポーズの最適化

**問題:**
- ARCore VIOのポーズが不正確な場合、統合時にずれが生じる

**対策:**
- 姿勢グラフ最適化（Pose Graph Optimization）を実装
- RGBD Odometryで微調整

**実装難易度:** ⭐⭐⭐⭐ (実装が複雑)

### 3. MVS（COLMAP）パイプラインへの移行

**理由:**
- MiDaS深度推定は単一画像からの推定のため、精度が限定的
- MVS（マルチビュー・ステレオ）は、複数画像からより高精度な深度推定が可能

**期待される改善:**
- 部屋認識が90-95%改善
- テクスチャマッピングが可能

**実装難易度:** ⭐⭐⭐⭐ (実装が複雑、処理時間が長い)

---

## まとめ

### 実施した改善

1. ✅ **MiDaS深度推定のスケールを拡大** (5.0 → 10.0)
2. ✅ **深度の最大値を拡大** (7.0m → 10.0m)
3. ✅ **最小深度を調整** (0.1m → 0.2m)
4. ✅ **TSDF解像度を調整** (0.02m → 0.03m)
5. ✅ **デバッグ出力を追加**

### 期待される結果

- 深度範囲が拡大（0.2m - 8m程度）
- 部屋の壁までの距離をカバー
- 部屋の構造が認識される

### 次のステップ

1. 新しいジョブでテスト（より多くのフレームを推奨）
2. 深度範囲を確認して微調整
3. 必要に応じて、MVS（COLMAP）パイプラインへの移行を検討

---

## 参考情報

- `SERVER_SIDE_DEPTH_ESTIMATION_ANALYSIS.md`: サーバー側深度推定の詳細
- `INDUSTRY_APPROACHES_COMPARISON.md`: 業界標準との比較
- `ROOM_RECOGNITION_IMPROVEMENT.md`: 部屋認識改善ガイド

