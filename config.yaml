# ARCore + Open3D Server Configuration

server:
  host: "0.0.0.0"
  port: 8002
  data_dir: "/opt/arcore-open3d-gpu/data"
  results_dir: "/opt/arcore-open3d-gpu/results"

processing:
  # 処理モード:
  # - "mvs": COLMAP MVSパイプライン（従来方式）
  # - "rgbd": ARCore Depth + Open3D TSDF
  # - "colmap_depth": 方法C - スケール補正付きCOLMAP深度統合
  #                   COLMAPの滑らかな深度 + ARCoreの正確な位置姿勢
  default_mode: "mvs"
  
  tsdf:
    voxel_length: 0.01  # 10mm (高密度、backupと同等)
    sdf_trunc: 0.08     # 80mm (voxel_length x 8)
    color_type: "RGB8"
  
  depth:
    scale: 1000.0
    trunc: 5.0          # 5m以内（ノイズ削減）
    min_depth: 0.2
    filter_noise: true
    bilateral_filter: true
    bilateral_d: 5
    bilateral_sigma_color: 100.0
    bilateral_sigma_space: 100.0
  
  pointcloud:
    voxel_down_size: 0.01
    remove_outliers: true
    nb_neighbors: 30
    std_ratio: 1.5
    radius_outlier_removal: true
    radius: 0.05
    min_neighbors: 10
    smooth: true
    smooth_iterations: 1

mesh:
  method: "poisson"
  
  poisson:
    depth: 10
    width: 0
    scale: 1.1
    linear_fit: false
    density_threshold_percentile: 5
  
  smoothing:
    enable: true
    method: "laplacian"
    iterations: 10
    lambda_filter: 0.3
  
  optimization:
    enable: true
    remove_duplicates: true
    remove_degenerate: true
    orient_normals: true
  
  quality_improvement:
    enable: true
    subdivision:
      enable: true
      method: "loop"
      iterations: 2
      max_iterations: 2
      max_triangles: 10000000
    normal_improvement:
      enable: true
      method: "weighted"
      smooth_normals: true
    color_enhancement:
      enable: true
      contrast: 1.1
      saturation: 1.1
      brightness: 1.0

depth_estimation:
  enable: true
  model: "DPT_Large"
  device: "cuda"
  force_use: false  # ARCore Depthを使用

colmap:
  path: "colmap"
  
  # 方式2: ARCoreポーズをpose_priorsとして使用
  # COLMAP SfMにARCoreの位置情報を拘束条件として渡す
  # これにより、メッシュがARCore座標系に近い形で生成される
  use_pose_priors: true  # テスト用に有効化
  
  # pose_prior設定（use_pose_priors=true時に使用）
  pose_prior:
    # 位置の標準偏差（メートル）- ARCoreの精度に基づく
    # 小さいほどARCoreに強く従う、大きいほどCOLMAPの自由度が増す
    position_std_x: 0.1  # 10cm
    position_std_y: 0.1
    position_std_z: 0.1
    # ロバスト損失を使用（外れ値に強い）
    use_robust_loss: true
  
  # SfMスキップモード（実験的）- 非推奨
  # true: ARCoreのポーズを直接使用（SfMをスキップ）- 現在未対応
  # false: COLMAPのSfMでポーズを算出
  use_arcore_poses: false
  
  # マッチング方式（"exhaustive" または "sequential"）
  # - exhaustive: 全画像ペアをマッチング（高精度だが低速）
  # - sequential: 隣接画像のみマッチング（高速、ARCore連続撮影に最適）
  matcher: "exhaustive"
  
  # sequential_matcher設定
  sequential_matching:
    overlap: 10           # 前後何枚の画像とマッチングするか
    quadratic_overlap: true  # 二次的オーバーラップ
    loop_detection: false    # ループ検出（大規模シーン向け）
  
  patch_match_iterations: 3
  fusion_min_num_pixels: 5
  max_image_size: 2400
  window_radius: 5
  cache_size: 16
  
  # 距離フィルタリング（カメラ位置からの距離でフィルタ）
  # 注意: 座標変換が不正確な場合、フィルタが過剰に点を削除する可能性あり
  distance_filter:
    enable: false  # 一時的に無効化（座標変換の精度改善後に再有効化）
    min_distance: 0.1   # カメラから0.1m未満は除外（近すぎるノイズ）
    max_distance: 3.0   # カメラから3.0m以上は除外（遠すぎる誤差大）

# 方法C: スケール補正付きCOLMAP深度統合
colmap_depth:
  # GPU TSDF統合設定
  voxel_size: 0.02      # 2cm解像度 (メモリ節約)
  block_resolution: 16
  block_count: 100000
  
  # 深度マップ設定
  depth_scale: 1.0      # スケール補正後なので1.0
  depth_max: 5.0        # 最大深度（メートル）
  depth_min: 0.1        # 最小深度（メートル）
  
  # メッシュ生成設定
  extract_mesh: true
  mesh_weight_threshold: 3.0  # メッシュ抽出の重み閾値
  
  # 未登録フレームの処理
  skip_unregistered: true  # COLMAPで未登録のフレームはスキップ

# 座標系位置合わせ設定
alignment:
  # ARCore回転を直接使用（推奨）
  # COLMAPの回転推定は55°以上の誤差があるため、ARCoreの高精度な回転を使用
  use_arcore_rotation: true
  
  # セグメント別局所補正
  # COLMAPとARCoreの軌跡のずれを時間セグメントごとに補正
  segment_correction:
    enable: true
    segment_duration_sec: 2.0  # セグメント長（秒）
                                # 短いほど精度向上、長いほどメッシュ安定
                                # 推奨: 1-5秒
    min_points_per_segment: 3  # セグメント内の最小点数
    
  # メッシュへの補正適用
  mesh_correction:
    enable: true
    interpolation_neighbors: 3  # 最近傍カメラ数（重み付け平均）

gpu:
  enabled: true
  device_id: 0
  use_cuda: true
  cuda_available: true
  allow_fallback_to_cpu: false
  memory_fraction: 0.9
  allow_growth: true

output:
  point_cloud:
    format: "ply"
    with_normals: true
    with_colors: true
  
  mesh:
    format: "ply"
    compute_normals: true
    simplify: false
    target_triangles: 100000
    simplify_for_viewer: true
    max_triangles_for_viewer: 500000

viewer:
  default_view: "mesh"
  auto_load:
    point_cloud: false
    mesh: true
    rfid: true

logging:
  level: "INFO"
  file: "/var/log/arcore-open3d/server.log"
