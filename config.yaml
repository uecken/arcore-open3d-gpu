# ARCore + Open3D Server Configuration

server:
  host: "0.0.0.0"
  port: 8002
  data_dir: "/opt/arcore-open3d-gpu/data"
  results_dir: "/opt/arcore-open3d-gpu/results"

processing:
  default_mode: "rgbd"
  
  tsdf:
    # MiDaS深度推定を使用する場合、部屋全体をカバーするため、TSDF解像度を調整
    # 部屋スキャンでは、細かすぎる解像度（0.02m）はノイズを拾いやすい
    # バランスを取って、0.03m（30mm）に設定（部屋の構造を保持しつつ、ノイズを減らす）
    voxel_length: 0.03         # 30mm解像度（0.02 → 0.03、部屋全体を安定して統合するため）
    sdf_trunc: 0.24            # 8倍（voxel_lengthの8倍程度: 0.03 * 8 = 0.24）
    color_type: "RGB8"
  
  depth:
    scale: 1000.0
    # MiDaS深度推定を使用する場合、部屋全体をカバーするため、より大きな範囲が必要
    # 部屋の壁までの距離は通常3-5m、大きな部屋では5-8m程度
    trunc: 10.0                # 7.0 → 10.0mに変更（MiDaS深度推定で部屋全体をカバーするため）
    min_depth: 0.2             # 0.1 → 0.2mに変更（近すぎる深度を除外してノイズを減らす）
    # 深度データのフィルタリング（有効ピクセルが少ないため重要）
    filter_noise: true         # 統計的外れ値除去を有効化
    bilateral_filter: true     # エッジ保持平滑化を有効化
    bilateral_d: 5
    bilateral_sigma_color: 75.0  # 50.0 → 75.0（より強く平滑化、メッシュ品質向上）
    bilateral_sigma_space: 75.0  # 50.0 → 75.0（より強く平滑化、メッシュ品質向上）
  
  pointcloud:
    voxel_down_size: 0.01     # 5mm（より高解像度）
    remove_outliers: true
    nb_neighbors: 30           # より多くの近傍点で判定
    std_ratio: 1.5             # より厳しい外れ値除去
    # 追加のフィルタリング
    radius_outlier_removal: true
    radius: 0.05
    min_neighbors: 10
    # 平滑化
    smooth: true
    smooth_iterations: 1

mesh:
  method: "poisson"
  
  poisson:
    depth: 10                  # より高解像度（9→10）
    width: 0
    scale: 1.1
    linear_fit: false
    # 密度フィルタリングの調整
    density_threshold_percentile: 5  # 下位5%を除去（より厳しく）
  
  # メッシュ平滑化（部屋認識改善のため強化）
  smoothing:
    enable: true
    method: "laplacian"        # laplacian or taubin
    iterations: 10             # 8 → 10に増やしてより滑らかに（部屋の壁面を滑らかに）
    lambda_filter: 0.3         # 0.4 → 0.3に減らしてより強く平滑化
  
  # メッシュ最適化
  optimization:
    enable: true
    remove_duplicates: true
    remove_degenerate: true
    orient_normals: true
  
  # メッシュ品質向上（表示品質改善）
  quality_improvement:
    enable: true
    # メッシュ細分化（Subdivision）- 滑らかな表面を実現（部屋認識改善のため強化）
    subdivision:
      enable: true
      method: "loop"            # loop or midpoint
      iterations: 2             # 細分化の反復回数（1 → 2、部屋の詳細を保持するため）
      max_iterations: 2        # 最大反復回数
      max_triangles: 10000000   # この三角形数以上は細分化をスキップ（5000000 → 10000000、部屋全体に対応）
    # 法線の改善
    normal_improvement:
      enable: true
      method: "weighted"        # weighted or simple
      smooth_normals: true      # 法線の平滑化
    # 色の補正と強化
    color_enhancement:
      enable: true
      contrast: 1.1             # コントラスト調整（1.0 = 変更なし、>1.0 = 強化）
      saturation: 1.1           # 彩度調整（1.0 = 変更なし、>1.0 = 強化）
      brightness: 1.0           # 明度調整（1.0 = 変更なし）

depth_estimation:
  enable: true
  model: "DPT_Large"
  device: "cuda"
  # 深度推定の強制使用（Depthデータがあっても再推定して品質向上）
  force_use: true  # trueにすると、DepthデータがあってもMiDaSで再推定（GPU使用）
                   # 業界標準に合わせてARCore Depth APIを無視し、MiDaSで高精度な深度推定を行う

gpu:
  enabled: true
  device_id: 0
  use_cuda: true
  # CUDA設定
  cuda_available: true  # CUDAが利用可能かどうか（自動検出も可能）
  allow_fallback_to_cpu: false  # GPUが利用できない場合にCPUにフォールバックするか
  # メモリ管理
  memory_fraction: 0.9  # GPUメモリの使用率（0.0-1.0）
  allow_growth: true  # メモリを必要に応じて動的に確保

output:
  point_cloud:
    format: "ply"
    with_normals: true
    with_colors: true
  
  mesh:
    format: "ply"
    compute_normals: true
    simplify: false
    target_triangles: 100000
    # ビューアー表示用の簡略化設定
    simplify_for_viewer: true  # web表示用の簡略化を有効にするか（true/false）- 大きなメッシュ（1GB以上）は必須
    max_triangles_for_viewer: 500000  # ビューアー表示用の最大三角形数（50万、simplify_for_viewer=trueの場合のみ適用）

# ビューアー設定
viewer:
  # 初期表示設定
  default_view: "mesh"  # 初期表示モード: "mesh" または "pointcloud"
  # 初期読み込み設定
  auto_load:
    point_cloud: false  # 初期読み込み時に点群を読み込むか（false推奨、メモリ節約）
    mesh: true          # 初期読み込み時にメッシュを読み込むか（true推奨）
    rfid: true          # 初期読み込み時にRFIDデータを読み込むか

logging:
  level: "INFO"
  file: "/var/log/arcore-open3d/server.log"
